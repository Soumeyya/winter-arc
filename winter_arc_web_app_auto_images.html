<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Winter Arc Trainer</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0ea5e9">
<style>
  :root { --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --accent:#0ea5e9; --good:#22c55e; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink);}
  header{position:sticky;top:0;z-index:10; backdrop-filter:saturate(1.2) blur(8px); background:rgba(11,18,32,.7); border-bottom:1px solid #1f2937;}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:0;display:flex;align-items:center;gap:10px}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label.btn,input[type=file]::file-selector-button,.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#111827;color:var(--ink);border:1px solid #1f2937;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:white}
  .btn.good{background:var(--good);border-color:transparent;color:white}
  select, input[type="text"]{background:#0b1220;color:var(--ink);border:1px solid #1f2937;border-radius:10px;padding:8px 10px}
  .tabs{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .tab{padding:8px;border:1px solid #1f2937;border-radius:10px;text-align:center;background:#0b1220;cursor:pointer;font-size:13px}
  .tab.active{background:#111827;border-color:#334155}
  .exercise{display:flex;gap:12px;align-items:center;padding:10px;border:1px solid #1f2937;border-radius:12px;background:#0b1220}
  .exercise img{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid #1f2937;background:#0b1220}
  .exercise .meta{flex:1;min-width:0}
  .title{font-weight:600}
  .muted{color:var(--muted);font-size:12px}
  .footer{position:sticky;bottom:0;background:rgba(11,18,32,.8);backdrop-filter:saturate(1.2) blur(8px);border-top:1px solid #1f2937}
  .help{font-size:12px;color:var(--muted)}
  .hint{background:#05202d;border:1px dashed #0ea5e9;color:#bae6fd;padding:10px;border-radius:12px}
  .checkbox{width:28px;height:28px;border-radius:8px;border:2px solid #334155;display:grid;place-items:center;cursor:pointer}
  .checkbox.done{background:var(--good);border-color:var(--good)}
  .checkbox svg{width:18px;height:18px;fill:none;stroke:white;stroke-width:3;opacity:0}
  .checkbox.done svg{opacity:1}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .hidden{display:none}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #1f2937;background:#0b1220}
</style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between;">
    <h1>üèãÔ∏è Winter Arc Trainer</h1>
    <div class="toolbar">
      <button class="btn" id="importCsvBtn">Import CSV</button>
      <input class="hidden" id="csvInput" type="file" accept=".csv,text/csv" />
      <label class="btn" for="imgInput">Add Images</label>
      <input class="hidden" id="imgInput" type="file" accept="image/*" multiple />
      <button class="btn" id="autoAssignBtn">Auto‚Äëassign images</button>
      <label class="pill"><input id="tryOnline" type="checkbox"> Try online fallback</label>
      <button class="btn" id="exportBtn">Export progress</button>
    </div>
  </div>
</header>

<main class="wrap grid" style="padding-top:12px;padding-bottom:90px;">
  <section class="card grid">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:10px">
        <label>Week</label>
        <select id="weekSelect"></select>
      </div>
      <div class="row help">
        <span id="planInfo">No plan imported</span>
      </div>
    </div>

    <div class="tabs" id="dayTabs"></div>

    <div id="exList" class="grid"></div>

    <div class="hint">
      <b>Tip</b> ‚Äî Add a folder of exercise photos first. Hit <b>Auto‚Äëassign images</b> to match files to exercises using filename keywords (e.g. <code>leg_press.jpg</code> ‚Üí ‚ÄúLeg press‚Äù). If <b>Try online fallback</b> is on, the app will attempt a safe Wikipedia thumbnail when no local image is found.
    </div>
  </section>
</main>

<footer class="footer">
  <div class="wrap row" style="justify-content:space-between;align-items:center;padding:10px 16px;">
    <div class="help">Add to Home Screen for app-like use. Progress saves locally.</div>
    <button class="btn primary" id="installBtn">Install</button>
  </div>
</footer>

<script>
function parseCSV(text) {
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  while (i < text.length) {
    const c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (text[i+1] === '"') { field += '"'; i++; }
        else { inQuotes = false; }
      } else field += c;
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ',') { row.push(field.trim()); field=''; }
      else if (c === '\n' || c === '\r') {
        if (field.length || row.length) { row.push(field.trim()); rows.push(row); row=[]; field=''; }
        if (c === '\r' && text[i+1] === '\n') i++;
      } else field += c;
    }
    i++;
  }
  if (field.length || row.length) { row.push(field.trim()); rows.push(row); }
  return rows;
}

// ---------- State ----------
const $ = sel => document.querySelector(sel);
const weekSelect = $('#weekSelect');
const dayTabs = $('#dayTabs');
const exList = $('#exList');
const planInfo = $('#planInfo');
const csvInput = $('#csvInput');
const imgInput = $('#imgInput');
const importCsvBtn = $('#importCsvBtn');
const exportBtn = $('#exportBtn');
const autoAssignBtn = $('#autoAssignBtn');
const tryOnline = $('#tryOnline');
const installBtn = $('#installBtn');

const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let PLAN = JSON.parse(localStorage.getItem('wa_plan') || '[]');
let IMAGES = {}; // filename -> ObjectURL
let IMAGE_MAP = JSON.parse(localStorage.getItem('wa_image_map') || '{}'); // exerciseName -> filename
let PROGRESS = JSON.parse(localStorage.getItem('wa_progress') || '{}'); // key -> true

function saveAll() {
  localStorage.setItem('wa_plan', JSON.stringify(PLAN));
  localStorage.setItem('wa_progress', JSON.stringify(PROGRESS));
  localStorage.setItem('wa_image_map', JSON.stringify(IMAGE_MAP));
}

// ---------- Helpers ----------
const norm = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
function keyFor(w, d, name) { return `${w}|${d}|${name}`; }
function tokens(s){ return norm(s).split(' ').filter(Boolean); }
function scoreMatch(exName, fileName) {
  const exT = tokens(exName);
  const fT = tokens(fileName.replace(/\.[a-z0-9]+$/i,''));
  let score = 0;
  exT.forEach(t => { if (fT.includes(t)) score += 1; });
  // bonus for exact start token
  if (fT.length && exT.length && fT[0] === exT[0]) score += 0.5;
  return score;
}

// Built-in minimalist icons (SVG) per keyword as fallback
const ICONS = {
  "leg press": `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 19h18v2H3zM6 17h2l2-5h2l1 3h2l1-3h2l2 5h2l-3-8h-4l-1 3-1-3H9z"/></svg>`,
  "leg curl": `<svg viewBox="0 0 24 24"><circle cx="6" cy="18" r="2" fill="currentColor"/><path d="M6 18L14 6h4" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "hip thrust": `<svg viewBox="0 0 24 24"><rect x="3" y="10" width="18" height="4" rx="2" fill="currentColor"/><circle cx="7" cy="12" r="2" fill="#0b1220"/><circle cx="17" cy="12" r="2" fill="#0b1220"/></svg>`,
  "glute bridge": `<svg viewBox="0 0 24 24"><path d="M3 16c4-6 14-6 18 0" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "calf raise": `<svg viewBox="0 0 24 24"><path d="M6 20h12M8 18v-6m8 6v-8" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "treadmill": `<svg viewBox="0 0 24 24"><path d="M3 18h14l3-8" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="6" cy="19" r="1" fill="currentColor"/><circle cx="15" cy="19" r="1" fill="currentColor"/></svg>`,
  "bike": `<svg viewBox="0 0 24 24"><circle cx="6" cy="17" r="3" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="18" cy="17" r="3" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9 17l3-8h3l2 5" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "kickback": `<svg viewBox="0 0 24 24"><path d="M4 12h8l6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "band walk": `<svg viewBox="0 0 24 24"><rect x="5" y="15" width="14" height="3" rx="1.5" fill="currentColor"/></svg>`,
  "seated row": `<svg viewBox="0 0 24 24"><path d="M4 12h10" stroke="currentColor" stroke-width="2"/><circle cx="15" cy="12" r="2" fill="currentColor"/></svg>`,
  "lat pulldown": `<svg viewBox="0 0 24 24"><path d="M4 6h16M12 6v8" stroke="currentColor" stroke-width="2"/></svg>`,
  "back extension": `<svg viewBox="0 0 24 24"><path d="M4 16c4-4 12-4 16 0" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "face pull": `<svg viewBox="0 0 24 24"><path d="M6 12h12" stroke="currentColor" stroke-width="2"/><circle cx="6" cy="12" r="2" fill="currentColor"/><circle cx="18" cy="12" r="2" fill="currentColor"/></svg>`,
  "bird dog": `<svg viewBox="0 0 24 24"><path d="M4 14h10l6-4" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "side plank": `<svg viewBox="0 0 24 24"><path d="M6 18l12-6" stroke="currentColor" stroke-width="2"/></svg>`,
  "walk": `<svg viewBox="0 0 24 24"><path d="M7 20l3-6 4 2 3-6" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "stretch": `<svg viewBox="0 0 24 24"><path d="M4 18c6-8 10-8 16 0" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
  "hip thrust circuit": `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 7v10" stroke="currentColor" stroke-width="2"/></svg>`
};

function iconFor(exName){
  const n = norm(exName);
  for (const k in ICONS) { if (n.includes(k)) return ICONS[k]; }
  return null;
}

// ---------- UI Render ----------
function refreshWeekSelect() {
  const weeks = [...new Set(PLAN.map(r => Number(r.week)).filter(Boolean))].sort((a,b)=>a-b);
  weekSelect.innerHTML = weeks.length ? weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('') : `<option value="1">Week 1</option>`;
  if (!weeks.length) weekSelect.value = "1";
}

function renderTabs(activeDay) {
  dayTabs.innerHTML = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map((abbr,i) => {
    const d = DAYS[i];
    return `<button class="tab ${d===activeDay?'active':''}" data-day="${d}">${abbr}</button>`;
  }).join('');
  dayTabs.querySelectorAll('.tab').forEach(btn => btn.onclick = () => {
    renderTabs(btn.dataset.day);
    renderList(Number(weekSelect.value), btn.dataset.day);
  });
}

function renderList(week, day) {
  const rows = PLAN.filter(r => Number(r.week)===Number(week) && r.day.toLowerCase()===day.toLowerCase());
  if (!rows.length) {
    exList.innerHTML = `<div class="muted">No exercises for ${day} in Week ${week}.</div>`;
    return;
  }
  exList.innerHTML = '';
  rows.forEach(r => {
    const k = keyFor(week, day, r.exercise);
    const done = !!PROGRESS[k];
    const imgFile = IMAGE_MAP[r.exercise] || r.image || '';
    const imgURL = (imgFile && IMAGES[imgFile]) ? IMAGES[imgFile] : '';
    const icon = iconFor(r.exercise);
    const card = document.createElement('div');
    card.className = 'exercise';
    const visual = imgURL ? `<img alt="img" src="${imgURL}" />` : (icon ? `<div style="width:64px;height:64px;display:grid;place-items:center;border:1px solid #1f2937;border-radius:10px;background:#0b1220;color:#93c5fd">${icon}</div>` : `<div style="width:64px;height:64px;border:1px dashed #334155;border-radius:10px;display:grid;place-items:center" class="muted">No image</div>`);
    card.innerHTML = `
      ${visual}
      <div class="meta">
        <div class="title">${r.exercise}</div>
        <div class="muted">${r.reps || ''}</div>
      </div>
      <div class="checkbox ${done?'done':''}" role="checkbox" aria-checked="${done}" data-key="${k}" title="Mark done">
        <svg viewBox="0 0 24 24"><path d="M4 12l5 5 11-11"/></svg>
      </div>
    `;
    exList.appendChild(card);
  });
  exList.querySelectorAll('.checkbox').forEach(box => {
    box.onclick = () => {
      const k = box.dataset.key;
      if (box.classList.toggle('done')) PROGRESS[k] = true; else delete PROGRESS[k];
      saveAll();
    };
  });
}

// ---------- Importers ----------
importCsvBtn.onclick = () => csvInput.click();
csvInput.onchange = async (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  const text = await f.text();
  const rows = parseCSV(text);
  if (!rows.length) { alert('Empty CSV'); return; }
  const head = rows[0].map(h => h.toLowerCase());
  const idx = {
    week: head.indexOf('week'),
    day: head.indexOf('day'),
    exercise: head.indexOf('exercise'),
    reps: head.indexOf('reps'),
    image: head.indexOf('image'),
  };
  if (Object.values(idx).some(i => i === -1)) { alert('CSV must have columns: week, day, exercise, reps, image'); return; }
  PLAN = rows.slice(1).filter(r => r.length >= 5).map(r => ({
    week: r[idx.week],
    day: r[idx.day],
    exercise: r[idx.exercise],
    reps: r[idx.reps],
    image: r[idx.image]
  }));
  saveAll();
  refreshWeekSelect();
  planInfo.textContent = `Loaded ${PLAN.length} items`;
  renderTabs(DAYS[new Date().getDay()-1] || 'Monday');
  renderList(Number(weekSelect.value), DAYS[new Date().getDay()-1] || 'Monday');
  csvInput.value = '';
};

imgInput.onchange = (e) => {
  const files = Array.from(e.target.files || []);
  files.forEach(f => { IMAGES[f.name] = URL.createObjectURL(f); });
  localStorage.setItem('wa_images', JSON.stringify(Object.keys(IMAGES)));
  planInfo.textContent = `Images loaded: ${Object.keys(IMAGES).length}`;
};

// ---------- Auto-assign images ----------
autoAssignBtn.onclick = async () => {
  let assigned = 0, total = 0;
  const fileNames = Object.keys(IMAGES);
  PLAN.forEach(r => {
    total++;
    // If already mapped, skip
    if (IMAGE_MAP[r.exercise]) return;
    // Score filenames and pick best
    let best = {name:null,score:-1};
    for (const fn of fileNames) {
      const sc = scoreMatch(r.exercise, fn);
      if (sc > best.score) best = {name:fn, score:sc};
    }
    if (best.score >= 1) { // threshold
      IMAGE_MAP[r.exercise] = best.name;
      assigned++;
    } else if (tryOnline.checked) {
      // fallback: try Wikimedia thumbnail
      fetchWikiThumb(r.exercise).then(url => {
        if (url) {
          // Create proxy object URL by fetching the image
          fetch(url).then(res => res.blob()).then(blob => {
            const fname = `web_${norm(r.exercise).replace(/\s+/g,'_')}.jpg`;
            IMAGES[fname] = URL.createObjectURL(blob);
            IMAGE_MAP[r.exercise] = fname;
            saveAll();
            // re-render current view to show newly assigned image
            const activeDay = document.querySelector('.tab.active')?.dataset.day || DAYS[0];
            renderList(Number(weekSelect.value), activeDay);
          });
        }
      }).catch(()=>{});
    }
  });
  saveAll();
  alert(`Auto‚Äëassign complete: ${assigned} of ${total} exercises matched to local images${tryOnline.checked ? ' (others will try online)' : ''}.`);
  const activeDay = document.querySelector('.tab.active')?.dataset.day || DAYS[0];
  renderList(Number(weekSelect.value), activeDay);
};

async function fetchWikiThumb(query){
  try{
    const url = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=thumbnail&pithumbsize=240&origin=*&titles=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    const data = await res.json();
    const pages = data?.query?.pages || {};
    for (const k in pages){
      const p = pages[k];
      if (p.thumbnail && p.thumbnail.source) return p.thumbnail.source;
    }
  }catch(e){}
  return null;
}

// ---------- Week/day changes ----------
weekSelect.onchange = () => {
  const active = document.querySelector('.tab.active')?.dataset.day || DAYS[0];
  renderList(Number(weekSelect.value), active);
};

// ---------- Init ----------
(function init(){
  // Try restore remembered images (names only)
  try {
    const names = JSON.parse(localStorage.getItem('wa_images')||'[]');
    names.forEach(n => IMAGES[n] = IMAGES[n] || null); // placeholders; user reattaches to populate ObjectURLs
  } catch {}
  refreshWeekSelect();
  renderTabs(DAYS[new Date().getDay()-1] || 'Monday');
  planInfo.textContent = PLAN.length ? `Loaded ${PLAN.length} items` : 'No plan imported';
  renderList(Number(weekSelect.value), DAYS[new Date().getDay()-1] || 'Monday');
})();

// ---------- Export ----------
exportBtn.onclick = () => {
  const lines = ['week,day,exercise,reps,done,imageFile'];
  PLAN.forEach(r => {
    const k = keyFor(r.week, r.day, r.exercise);
    const mapped = IMAGE_MAP[r.exercise] || r.image || '';
    lines.push([r.week, r.day, JSON.stringify(r.exercise), JSON.stringify(r.reps||''), PROGRESS[k] ? '1' : '0', JSON.stringify(mapped)].join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'winter_arc_progress.csv';
  a.click();
};

// ---------- PWA basics ----------
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  installBtn.disabled = false;
});
installBtn.onclick = async () => {
  if (deferredPrompt) { deferredPrompt.prompt(); }
  else alert('Use Share ‚Üí Add to Home Screen');
};

if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'wa-cache-v2';
    self.addEventListener('install', e => {
      e.waitUntil((async()=>{
        const cache = await caches.open(CACHE);
        try { await cache.addAll(['./']); } catch(e) {}
      })());
      self.skipWaiting();
    });
    self.addEventListener('activate', e => self.clients.claim());
    self.addEventListener('fetch', e => {
      const req = e.request;
      if (req.method !== 'GET') return;
      e.respondWith((async()=>{
        const cached = await caches.match(req);
        if (cached) return cached;
        try {
          const res = await fetch(req);
          const cache = await caches.open(CACHE);
          cache.put(req, res.clone());
          return res;
        } catch(err) {
          return cached || Response.error();
        }
      })());
    });
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl);
}
</script>
</body>
</html>
